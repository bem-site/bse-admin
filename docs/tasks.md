## Этапы сборки

Этапы сборки представляет собой модуль, который экспортирует функцию принимающую аргументом
объект сценария сборки и возвращающую fullfill vow promise c объектом сценария сборки
при успешном прохождении этапа сборки и reject vow promise с объектом ошибки выполнения.

Код простейшего модуля удовлетворяющего таким требованиям представлен ниже:

```
var vow = require('vow');

module.exports = function (target) {
    console.log('Hello world')
    return vow.resolve(target);
};
```

Если добавить такой этап сборки в любой из сценариев, то при выполнении такого модуля в консоль
выведется "Hello world".

Модули всех этапов сборки раположены в директории [targets](./src/tasks).

### Готовые этапы сборки

#### Очистка базы данных

* Модуль: [clear-db.js](./src/tasks/clear-db.js)

Удаляет все записи из базы данных.

#### Синхронизация документации

* Модуль: [docs.js](./src/tasks/docs.js)

#### Создание узлов авторов и переводчиков

* Модуль: [dynamic-people.js](./src/tasks/dynamic-people.js)

#### Создание узлов тегов

* Модуль: [dynamic-tags.js](./src/tasks/dynamic-tags.js)

#### Финализация сборки

* Модуль: [finalize.js](./src/tasks/finalize.js)

Последний модуль в очереди выполнения для всех сценариев.
Предназначен для вывод финального лога.

Кроме того в нем можно определить например отключение от базы данных.

#### Сборка файла из js файловой структуры модели

* Модуль: [get-jsmodel.js](./src/tasks/get-jsmodel.js)

Собирает единый `*.json` файл модели из js - файлов распределенных по папкам.
Сохраняет этот `*.json` файл на файловую систему в папку './cache'.

#### Инициализация

* Модуль: [init.js](./src/tasks/init.js)

Инициализирует подключение к локальной базе данных и github API.

#### Очистка кэша файлов библиотек блоков

* Модуль: [clear-cache.js](./src/tasks/libraries-cache.js)

Очищает файловый кэш для данных сборки по библиотекам.
Дополнительные опции переданных на данный этап сборки позволяют
выборочно очистить кэш для определенной библиотеки или выбранной версии библиотеки.

#### Синхронизация данных по библиотекам блоков с файловой системой

* Модуль: [libraries-files.js](./src/tasks/libraries-files.js)

#### Синхронизация данных по библиотекам блоков с базой данных

* Модуль: [libraries-db.js](./src/tasks/libraries-db.js)

#### Синхронизация модели

* Модуль: [nodes.js](./src/tasks/nodes.js)

#### Переопределение ссылок

* Модуль: [override-links.js](./src/tasks/override-links.js)

#### Синхронизация файла с мета-информацией по авторам и переводчикам

* Модуль: [people.js](./src/tasks/people.js)

Сверяет информацию по авторам и переводчикам между той версией, которая
находится в базе данных и версией расположенной на github. При различии
данных скачивает файл с обновленной информацией по авторам и переводчикам с github
и обновляет данные в локальной базе.

#### Удаление файла модели

* Модуль: [rm-model.js](./src/tasks/rm-model.js)

Удаляет файл модели после ее успешной обработки. Нужен для
предотвращения повторной синхронизации данных при последующих
запусках сборщика данных.

#### Построение данных для системы внутреннего поиска

* Модуль: [search-data.js](./src/tasks/search-data.js)

#### Создание структуры данных для файла sitemap.xml

* Модуль: [sitemap-xml.js](./src/tasks/sitemap-xml.js)

Этот модуль собирает все узлы имеющие url и и строит js модель соответствующую
файлу sitemap.xml для индексации сайта поисковыми системами. Узлы могут содержать
параметры которые переопределяют стандартные настройки индексации.

После построения модели она конвертируется в xml и сохраняется в базу данных.

#### Создание копии базы данных

* Модуль: [snapshot.js](./src/tasks/snapshot.js)

При наличии собранных изменений в процессе сборки на этом этапе
все файлы базы данных копируются в папку `snapshots/{dd:mm:yyyy-hh:mm:ss}`
где `dd:mm:yyyy-hh:mm:ss` дата создания копии базы данных в соответствующем формате.

Кроме файлов базы данных, папка бэкапа также содержит, файл `data.json`,
который содержит дату сборки и список изменений данных, которые произошли в результате сборки.

Также присуствуют файлы `libraries.json` и `blocks.json` которые нужны для сервисов поиска.

#### Переключение симлинки на копию базы данных

* Модуль: [switch-symlink.js](./src/tasks/switch-symlink.js)

Существует 2 симлинки расположенные в папке `db`:

* testing
* production

Папки, на которые указывают эти симлинки запрашиваются сайтом
соответственно с тестового и боевого окружений.

При этом тестовая симлинка переключается на последний созданный snapshot
сразу же после его создания.

#### Публикация модели на удаленный сервис

* Модуль: [update-model.js](./src/tasks/update-model.js)

Открывает, архивирует и отправляет файл модели на сервер сборки.

#### Построение карты ссылок - узлов модели

* Модуль: [urls-map.js](./src/tasks/urls-map.js)

Необходим для оптимальной работы роутера на сайте.
Задача роутера - нахождение нужного узла модели (точнее id узла) по url запроса.

Этот модуль строит карту соответствия всех маршрутов сайта узлам модели.
